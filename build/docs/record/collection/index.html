<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<title data-react-helmet="true">奇奇怪怪的错误们 | Arch Linux RISC-V Packaging Guide</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://riscv-notes.sh1mar.in/docs/record/collection"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="奇奇怪怪的错误们 | Arch Linux RISC-V Packaging Guide"><meta data-react-helmet="true" name="description" content="阿里云上遇到 sigsegv"><meta data-react-helmet="true" property="og:description" content="阿里云上遇到 sigsegv"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://riscv-notes.sh1mar.in/docs/record/collection"><link data-react-helmet="true" rel="alternate" href="https://riscv-notes.sh1mar.in/docs/record/collection" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://riscv-notes.sh1mar.in/docs/record/collection" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.da6dd648.css">
<link rel="preload" href="/assets/js/runtime~main.4a9f3433.js" as="script">
<link rel="preload" href="/assets/js/main.760832d3.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="ArchRV-Logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/logo.png" alt="ArchRV-Logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">ArchRV-Manual</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Documents</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/felixonmars/archriscv-packages" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">🌜</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">🌞</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="navbar__search searchBarContainer_I7kZ"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_Zg7X searchBarLoadingRing_J5Ez"><div></div><div></div><div></div><div></div></div><div class="searchHintContainer_CDc6"><kbd class="searchHint_2RRg">ctrl</kbd><kbd class="searchHint_2RRg">K</kbd></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">RISC-V 打包指引</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/guide/start-guide">Guide</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_TwRn" href="/docs/record/collection">Record</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/record/collection">奇奇怪怪的错误们</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/record/resources">一些参考资料</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/record/rust-related">Rust 相关的一些记录</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/record/unstable">随时会过时的记录</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>奇奇怪怪的错误们</h1></header><h2 class="anchor anchorWithStickyNavbar_y2LR" id="阿里云上遇到-sigsegv">阿里云上遇到 sigsegv<a class="hash-link" href="#阿里云上遇到-sigsegv" title="Direct link to heading">​</a></h2><p>如果在阿里云上遇到奇奇怪怪的 <code>segmentation fault</code>，
首先确认 rustc 的<a href="/docs/record/rust-related#%E7%BC%96%E8%AF%91%E6%97%B6%E9%81%87%E5%88%B0%E4%BA%86%E5%A5%87%E6%80%AA%E7%9A%84-sigsegv">优化</a>
有无问题，如果查不出来问题的话，
默认认为阿里云的虚拟化有问题。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="把-jemallocator-换成-tikv-jemallocator">把 jemallocator 换成 tikv-jemallocator<a class="hash-link" href="#把-jemallocator-换成-tikv-jemallocator" title="Direct link to heading">​</a></h2><p>Read: <a href="https://github.com/meilisearch/MeiliSearch/pull/1692" target="_blank" rel="noopener noreferrer">https://github.com/meilisearch/MeiliSearch/pull/1692</a></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="executable-wasm-ld-doesnt-exist-stuck">Executable &quot;wasm-ld&quot; doesn&#x27;t exist! (STUCK)<a class="hash-link" href="#executable-wasm-ld-doesnt-exist-stuck" title="Direct link to heading">​</a></h2><p>要安装 lld，wasm-ld 只在 lld 里面有。</p><hr><p>Firefox 的话，引入 lld 会带来另外的问题。lld 是需要默认关闭的，
问题来源于 <code>-mno-relax</code> 和 <code>-mrelax</code> 。</p><p>可以查看这个 PR 了解详情 <a href="https://github.com/felixonmars/archriscv-packages/pull/139" target="_blank" rel="noopener noreferrer">https://github.com/felixonmars/archriscv-packages/pull/139</a></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="pthread-related-issue">pthread related issue<a class="hash-link" href="#pthread-related-issue" title="Direct link to heading">​</a></h2><p>如果是 pthread 引起的 atomic 引用最好找 <code>-lpthread</code> 替换成 <code>-pthread</code>。</p><p>gcc/clang应该从十几年前就要求用 -pthread 了，现在还残留的 -lpthread
绝大多数是写错了。</p><p>给上游提交的时候可以说：</p><div class="codeBlockContainer_J+bg language-text theme-code-block"><div class="codeBlockContent_csEI text"><pre tabindex="0" class="prism-code language-text codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">This has been already discussed lengthly in GCC.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The answer is that -lpthead is only linking with the thread library,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">while -pthread actually means enabling thread support,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">which includes in the case of riscv64 -latomic,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">but also correctly define some macros when compiling code.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">In short this is not considered as a GCC bug.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>StackOverflow 也有相关讨论：
<a href="https://stackoverflow.com/questions/23250863/difference-between-pthread-and-lpthread-while-compiling" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/23250863/difference-between-pthread-and-lpthread-while-compiling</a></p><hr><p>关于如何跟上游对线的参考：
<a href="https://github.com/juce-framework/JUCE/issues/995" target="_blank" rel="noopener noreferrer">https://github.com/juce-framework/JUCE/issues/995</a></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="gcc-atomic">gcc atomic<a class="hash-link" href="#gcc-atomic" title="Direct link to heading">​</a></h2><p>gcc 的 1B 2B atomic 实现在 riscv64 有问题。gcc 的 1B 2B atomic 实现需要跑到 libatomic，
于是没法在编译期判断是否无锁</p><blockquote><p>ref: <a href="https://code.videolan.org/videolan/vlc/-/issues/20683" target="_blank" rel="noopener noreferrer">https://code.videolan.org/videolan/vlc/-/issues/20683</a></p><p>The GCC docs make it clear that -pthread is the correct way to use the pthread
library on POSIX systems.  Not only does it add extra necessary linker options
for some targets, but it also adds some extra necessary preprocessor options
for many targets.  There is also the issue that the library is called -lpthread
on some systems, and -lpthreads on others.  The -pthread option handles this
correctly.</p><p><strong>It is a known problem that the RISC-V gcc atomic support needs more work.
RISC-V only supports 4 and 8 byte atomic operations in hardware.  1 and 2 byte
operations are implemented using instruction sequences with locks, and this is
currently done via a call into libatomic.</strong>  However, mixing lock free and
non-locking atomic sequences can potentially cause run-time failures.  We need
to instead emit instruction sequences using 4 and/or 8 byte atomic instructions
without locks.  This is on the list of things that need to be fixed, but there
are a lot of things that need to be fixed and we haven&#x27;t gotten around to
fixing this one yet.  This definitively needs to be fixed before gcc 9, and
hopefully much sooner than that.</p><p>While the RISC-V gcc port does need to be fixed, it is still true that you
should be using -pthread instead of -lpthread.</p></blockquote><p>除此之外还有一个很诡异的事情：就是在 gcc 里，<code>std::atomic&lt;bool&gt;::is_always_lock_free</code>
是 false，<code>std::atomic&lt;int&gt;::is_always_lock_free</code> 是 true。但是如果你在运行的时候
整一个 bool b; <code>std::atomic_is_lock_free(&amp;b)</code>，你会发现它是 true，而且是，不管怎么试，
在哪试，它都是 true。</p><p>在 gcc 里面大概 ATOMIC_BOOL_LOCK_FREE 是 1（1 for the built-in atomic types
that are sometimes lock-free)</p><blockquote><p>ref: <a href="https://www.mail-archive.com/gcc-bugs@gcc.gnu.org/msg664254.html" target="_blank" rel="noopener noreferrer">https://www.mail-archive.com/gcc-bugs@gcc.gnu.org/msg664254.html</a></p><p>tldr: 只能等 gcc 的人实现 sub-word lock-free atomic 了</p><p>All atomic types except for std::atomic_flag may be implemented using mutexes
or other locking operations, rather than using the lock-free atomic CPU
instructions. Atomic types are also allowed to be sometimes lock-free, e.g. if
only aligned memory accesses are naturally atomic on a given architecture,
misaligned objects of the same type have to use locks.</p><p>Thanks for the detailed writeup!</p><p>Your analysis is basically correct, but I would add that ICC&#x27;s behavior here is
unsound (it only appears to &quot;implement[] this behavior correctly&quot; in simple cases)
whereas the GCC/Clang behavior is sound but surprising. For GCC, ICC, and Clang, <code>identity &lt;fp&gt;</code>
and <code>identity&lt;float&gt;</code> are the same type. Therefore it&#x27;s not possible for <code>identity &lt;fp&gt;::type</code>
and <code>identity&lt;float&gt;::type</code> to have different alignments, because they&#x27;re
the same type. So, for an example such as this:</p></blockquote><div class="codeBlockContainer_J+bg language-cpp theme-code-block"><div class="codeBlockContent_csEI cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">float</span><span class="token plain"> fp  </span><span class="token function" style="color:#d73a49">__attribute__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">aligned</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">cout </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">alignof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">typename</span><span class="token plain"> </span><span class="token class-name">identity</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">fp</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">endl</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">cout </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">alignof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">typename</span><span class="token plain"> </span><span class="token class-name">identity</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">float</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">endl</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><blockquote><p>under GCC and Clang, both lines print out 4, whereas under ICC, they either both
print out 4 or both print out 16 depending on which one happens to appear first
in the program (and in general you can encounter ODR violations when using ICC despite
there being nothing wrong at the source level).</p></blockquote><blockquote><p>Fundamentally, the &#x27;aligned&#x27; attribute is a GCC extension, so the GCC folks get
to define how it works. And they chose that instead of it resulting in a different
type that&#x27;s <em>almost</em> like the original type (for example, treating it as a type
qualifier), it results in the same type, but that in some contexts that same type
behaves differently. That&#x27;s a semantic disaster, but it&#x27;s what we live with. And
in particular, the only way for template instantiation to be sound in the presence
of this semantic disaster is for it to ignore all such attributes on template type
arguments.</p></blockquote><h2 class="anchor anchorWithStickyNavbar_y2LR" id="-fno-common">-fno-common<a class="hash-link" href="#-fno-common" title="Direct link to heading">​</a></h2><p><strong>Q</strong>: -fno-common 取代了 -fcommon, 这种情况优先 -fno-common 还是 patch source？</p><p><strong>A</strong>: 优先 patch source。
一般来说能不动flags尽量不动。
少数例外是，比如，这个项目死了十年了，连个repo都找不到。</p><p>不过如果是 -fcommon 这种，比较推荐的是先提给上游，咱们patch着打。
这样下次上游发版本arch那边更新的时候，就会莫名其妙好了，他们不用做什么，我们也只用删掉patch。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="-wno-format">-Wno-format<a class="hash-link" href="#-wno-format" title="Direct link to heading">​</a></h2><p>如果遇到
<code>cc1: error: -Wformat-security ignored without -Wformat [-Werror=format-security]</code>，
这个错误是因为代码被编译的时候，<code>CFLAG</code> 选项多了一个 <code>-Wno-format</code>，这个选项会关闭
<code>-Wformat</code>，但 <code>-Werror=format-security</code> 仍然保留着。</p><p>解决方案首先是让上游修，然后引用 patch，参考上面那一章节。</p><p>如果是一万年不更新的代码仓库，那可以酌情使用
<code>${CFLAG#-Werror=format-security}</code> 或者 <code>sed -i &#x27;s/ -Werror=format-security // Makefile</code>
把这个选项删除。</p><p>但是尽量现在群里讨论，问问前辈的意见。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="-werrorformat-security">-Werror=format-security<a class="hash-link" href="#-werrorformat-security" title="Direct link to heading">​</a></h2><div class="codeBlockContainer_J+bg language-text theme-code-block"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_oQzk">manpage</div><div class="codeBlockContent_csEI text"><pre tabindex="0" class="prism-code language-text codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">-Wformat-security</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   If -Wformat is specified, also warn about uses of format functions that represent possible security problems.  At present, this warns about calls to &quot;printf&quot; and &quot;scanf&quot; functions where the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   format string is not a string literal and there are no format arguments, as in &quot;printf (foo);&quot;.  This may be a security hole if the format string came from untrusted input and contains %n.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   (This is currently a subset of what -Wformat-nonliteral warns about, but in future warnings may be added to -Wformat-security that are not included in -Wformat-nonliteral.)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>首先，优先给上游发补丁。从 manpage 也可以看的出来，只需要把 <code>printf</code> 改成 <code>printf(&quot;%s&quot;)</code> 的形式即可。</p><p>除非上游十多年没动静，才可以选择把这个选项删掉。
可以用： <code>CFLAGS=${CFLAGS/-Werror=format-security/}</code></p><p>如果上游很难沟通，或者上游代码不太好修，优先自己修，然后和群里的前辈商量一下解决方案。</p><blockquote><p>Reference:
<a href="https://github.com/felixonmars/archriscv-packages/pull/559" target="_blank" rel="noopener noreferrer">https://github.com/felixonmars/archriscv-packages/pull/559</a></p></blockquote><h2 class="anchor anchorWithStickyNavbar_y2LR" id="如何快捷生成-sum">如何快捷生成 sum<a class="hash-link" href="#如何快捷生成-sum" title="Direct link to heading">​</a></h2><p>用 <a href="https://archlinux.org/packages/community/x86_64/pacman-contrib/" target="_blank" rel="noopener noreferrer">updpkgsums</a></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="修代码优先还是改编译-flag-优先">修代码优先还是改编译 flag 优先？<a class="hash-link" href="#修代码优先还是改编译-flag-优先" title="Direct link to heading">​</a></h2><p>优先修代码。</p><blockquote><p>参考：
<a href="https://build.opensuse.org/package/view_file/devel:ARM:Factory:Contrib:ILP32/presage/presage-0.9.1-gcc11.patch?expand=0" target="_blank" rel="noopener noreferrer">https://build.opensuse.org/package/view_file/devel:ARM:Factory:Contrib:ILP32/presage/presage-0.9.1-gcc11.patch?expand=0</a></p></blockquote><h2 class="anchor anchorWithStickyNavbar_y2LR" id="noqemu">noqemu<a class="hash-link" href="#noqemu" title="Direct link to heading">​</a></h2><p>能 patch 使用 generic 分支的就不要 noqemu</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="rust">Rust<a class="hash-link" href="#rust" title="Direct link to heading">​</a></h2><p>参考 <a href="/docs/record/rust-related"><em>Rust 相关的一些记录</em></a></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="sse-related-issue">SSE Related issue<a class="hash-link" href="#sse-related-issue" title="Direct link to heading">​</a></h2><p>Disable the build flag:</p><div class="codeBlockContainer_J+bg language-diff theme-code-block"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_oQzk">riscv64.patch</div><div class="codeBlockContent_csEI diff"><pre tabindex="0" class="prism-code language-diff codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">    -DOCIO_USE_SSE=OFF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Delete build flag:</p><div class="codeBlockContainer_J+bg language-diff theme-code-block"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_oQzk">riscv64.patch</div><div class="codeBlockContent_csEI diff"><pre tabindex="0" class="prism-code language-diff codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">build() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">  cd SuiteSparse-$pkgver</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token deleted-sign deleted prefix deleted" style="color:#d73a49">-</span><span class="token deleted-sign deleted line" style="color:#d73a49">  BLAS=-lblas LAPACK=-llapack TBB=-ltbb SPQR_CONFIG=-DHAVE_TBB MY_METIS_LIB=/usr/lib/libmetis.so make</span><br></span><span class="token-line" style="color:#393A34"><span class="token deleted-sign deleted line" style="color:#d73a49"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">  BLAS=-lblas LAPACK=-llapack MY_METIS_LIB=/usr/lib/libmetis.so make</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="go">Go<a class="hash-link" href="#go" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="patch-go-dep">Patch <code>go dep</code><a class="hash-link" href="#patch-go-dep" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_J+bg language-bash theme-code-block"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_oQzk">console</div><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">go mod edit -replace github.com/prometheus/client_golang</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">github.com/prometheus/client_golang@efe7aa7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">go mod download github.com/prometheus/client_golang</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 这个是根据不加 go get 的报错提示来添加的</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 没报错可以不用加，注意要去掉版本号（@ 后面的部分）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">go get github.com/prometheus/client_golang/prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">go generate  </span><span class="token comment" style="color:#999988;font-style:italic"># if necessary</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> cmd/traefik</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">go build</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><blockquote><p>具体参考：
<a href="https://github.com/felixonmars/archriscv-packages/pull/346/files" target="_blank" rel="noopener noreferrer">https://github.com/felixonmars/archriscv-packages/pull/346/files</a></p></blockquote><h3 class="anchor anchorWithStickyNavbar_y2LR" id="给-go-包的依赖的依赖打patch的正确方式">给 go 包的依赖（的依赖）打patch的正确方式<a class="hash-link" href="#给-go-包的依赖的依赖打patch的正确方式" title="Direct link to heading">​</a></h3><p>Go 比较特殊，Go 是在 build 的时候 install。
假设有一系列的依赖链：<code>a-&gt;b-&gt;c-&gt;d-&gt;e</code>。
如果需要修 d，则 bcd 都需要 fork，修好 d 之后 bc 改依赖。</p><p>Go 还可以在 go.mod 里用 replace 语法来替换依赖：</p><div class="codeBlockContainer_J+bg language-text theme-code-block"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_oQzk">go.mod</div><div class="codeBlockContent_csEI text"><pre tabindex="0" class="prism-code language-text codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">replace github.com/creack/goselect =&gt; github.com/creack/goselect v0.1.2</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><blockquote><p>具体参考：
<a href="https://github.com/felixonmars/archriscv-packages/pull/387/commits/ad0e66c31b21efd93fff93be8cce5b9e13b59953" target="_blank" rel="noopener noreferrer">https://github.com/felixonmars/archriscv-packages/pull/387/commits/ad0e66c31b21efd93fff93be8cce5b9e13b59953</a></p></blockquote><h3 class="anchor anchorWithStickyNavbar_y2LR" id="编译-golang-包的时候经常卡死">编译 golang 包的时候经常卡死<a class="hash-link" href="#编译-golang-包的时候经常卡死" title="Direct link to heading">​</a></h3><p>QEMU 的锅，直接杀掉重新开始。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="版本号">版本号<a class="hash-link" href="#版本号" title="Direct link to heading">​</a></h2><p>版本号不要超过主线，尽量以催更为主。
如果实在不行就加一行注释，提一下上游的进度，让以后维护的人有个参考。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="循环依赖">循环依赖<a class="hash-link" href="#循环依赖" title="Direct link to heading">​</a></h2><p>有些包可以一起打，但在状态页上显示互相缺了对方，这种需要 bootstrap。</p><blockquote><p>详细参考 ghc bootstrap Patch:
<a href="https://github.com/felixonmars/archriscv-packages/pull/17/commits/36279fff5314fbcd212549ede73db5257ef10b1d" target="_blank" rel="noopener noreferrer">https://github.com/felixonmars/archriscv-packages/pull/17/commits/36279fff5314fbcd212549ede73db5257ef10b1d</a></p></blockquote><h2 class="anchor anchorWithStickyNavbar_y2LR" id="intel-related">Intel related<a class="hash-link" href="#intel-related" title="Direct link to heading">​</a></h2><p>Intel 的一些包，没留 Generic 实现，只有 x86 simd 的，比如 hyperscan，
这种包就直接跳过不管了。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="qmake">Qmake<a class="hash-link" href="#qmake" title="Direct link to heading">​</a></h2><p>使用 qmake 构建的包构建时提示 <code>Could not find qmake spec &#x27;default&#x27;.</code></p><p>这种情况目前需要去板子上打包。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="xx-is-not-available-for-the-riscv64-architecture">XX is not available for the &#x27;riscv64&#x27; architecture<a class="hash-link" href="#xx-is-not-available-for-the-riscv64-architecture" title="Direct link to heading">​</a></h2><p>有些包需要修改 arch 的值才能编译，
否则会遇到 <code>==&gt; ERROR: cern-vdt is not available for the &#x27;riscv64&#x27; architecture</code>。</p><p>但请不要把 arch 改为 any，这里填 <code>riscv64</code> 即可。</p><p>你可以用 sed 快速替换值：</p><div class="codeBlockContainer_J+bg language-console theme-code-block"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_oQzk">console</div><div class="codeBlockContent_csEI console"><pre tabindex="0" class="prism-code language-console codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"># sed doesn&#x27;t support Extend RegEx(ERE) by default, need `-E` option to manually enable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sed -i -E &quot;s/arch=\(&#x27;?x86_64&#x27;?\)/arch=\(&#x27;riscv64&#x27;\)/&quot; PKGBUILD</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>还有请注意
<a href="/docs/guide/PR-guide#%E4%B8%8D%E8%A6%81%E6%8F%90%E4%BA%A4-archany">不要提交修改后的 arch</a></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="msse">msse<a class="hash-link" href="#msse" title="Direct link to heading">​</a></h2><p>Error: <code>c++: error: unrecognized command-line option &#x27;-msse&#x27;</code></p><p>这是因为 -msse 这个编译选项暂时还不支持 <code>x86_64</code> 以外的 Arch，
你需要查看一下这个项目的 CMakeList 选项，暂时把他关闭。</p><p>比如 <code>cmake -DSSE=OFF</code>。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="unknown-public-key-a-za-z0-9">Unknown public key <code>[a-zA-Z0-9]+</code><a class="hash-link" href="#unknown-public-key-a-za-z0-9" title="Direct link to heading">​</a></h2><p>这是因为本地的 gpg 数据库没有这个开发者的公钥。你可以用命令
<code>gpg --recv-key keyid</code> 下载并导入这个 key。</p><hr><p>如果遇到了 <code>gpg: keyserver receive failed: No data</code> 这样的错误，
大概率是 keyserver 被橄榄了。建议直接去项目主页找他们的 public key
手动导入。</p><blockquote><p>sks pool 因为是单增的，无法满足 GDPR 对被遗忘权的规定，
被欧盟法律橄榄了。</p></blockquote><hr><p>如果实在是找不到 key，可以用参数 <code>--skippgpcheck</code> 暂时跳过检查。</p><p>或者可以参考这个：
<a href="https://github.com/archlinuxcn/lilac/blob/master/recv_gpg_keys" target="_blank" rel="noopener noreferrer">https://github.com/archlinuxcn/lilac/blob/master/recv_gpg_keys</a></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="electron">Electron<a class="hash-link" href="#electron" title="Direct link to heading">​</a></h2><p>v8 版本低于 9.0 的就不用修了，从 9.0 开始有实验性的 risc-v 支持。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="node-sass">node-sass<a class="hash-link" href="#node-sass" title="Direct link to heading">​</a></h2><p>node-sass v6 就是不支持 node v17 的，node-sass 对 njs v17 的支持始于版本 7.0.0，
6.x 支持的 njs version：12, 14, 15, 16，所以要么就把 dependency 从 nodejs 改成 nodejs-lts-gallium，
要么就催上游更新 package.json 里 node-sass 的版本，which is nonsense，因为大版本号的更新往往带来不兼容。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="关于-upstream">关于 upstream<a class="hash-link" href="#关于-upstream" title="Direct link to heading">​</a></h2><p>如果上游的 maintainer 是肥猫的话，可以直接在群里 @ 肥猫。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="python-2to3">Python 2to3<a class="hash-link" href="#python-2to3" title="Direct link to heading">​</a></h2><p>Python 的包不管 major version 都要跑一次 2to3。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="测试">测试<a class="hash-link" href="#测试" title="Direct link to heading">​</a></h2><p>如果有的包不在乎测试是否通过，比如 <code>test || echo</code>，那就直接把测试注释掉。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="访问一些会在编译期被删除的文件">访问一些会在编译期被删除的文件<a class="hash-link" href="#访问一些会在编译期被删除的文件" title="Direct link to heading">​</a></h2><p>有一个比较脏的做法：往 PKGBUILD 里塞一个 bash，然后就用这个 subshell 来交互。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="gcc-nostdlib">gcc nostdlib<a class="hash-link" href="#gcc-nostdlib" title="Direct link to heading">​</a></h2><p><code>-nostdlib</code> 会覆盖 <code>-pthread</code></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="glibc-optimization">glibc optimization<a class="hash-link" href="#glibc-optimization" title="Direct link to heading">​</a></h2><div class="codeBlockContainer_J+bg language-text theme-code-block"><div class="codeBlockContent_csEI text"><pre tabindex="0" class="prism-code language-text codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">error: glibc cannot be compiled without optimization</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>solution: 加上 <code>-O1</code></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="patch-hunk-offset">patch hunk offset<a class="hash-link" href="#patch-hunk-offset" title="Direct link to heading">​</a></h2><p><strong>Q:</strong> 平时更新 patch 的时候，如果有代码的 patch hunk 飘了，能打上但是有 offset，需要
把 patch 更新成最新的行号吗？</p><p><strong>A:</strong> 不需要</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/Avimitin/RISC-V_Daily_Notes/docs/record/collection.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/guide/bug-report"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">如何给 Arch 报 BUG</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/record/resources"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">一些参考资料</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#阿里云上遇到-sigsegv" class="table-of-contents__link toc-highlight">阿里云上遇到 sigsegv</a></li><li><a href="#把-jemallocator-换成-tikv-jemallocator" class="table-of-contents__link toc-highlight">把 jemallocator 换成 tikv-jemallocator</a></li><li><a href="#executable-wasm-ld-doesnt-exist-stuck" class="table-of-contents__link toc-highlight">Executable &quot;wasm-ld&quot; doesn&#39;t exist! (STUCK)</a></li><li><a href="#pthread-related-issue" class="table-of-contents__link toc-highlight">pthread related issue</a></li><li><a href="#gcc-atomic" class="table-of-contents__link toc-highlight">gcc atomic</a></li><li><a href="#-fno-common" class="table-of-contents__link toc-highlight">-fno-common</a></li><li><a href="#-wno-format" class="table-of-contents__link toc-highlight">-Wno-format</a></li><li><a href="#-werrorformat-security" class="table-of-contents__link toc-highlight">-Werror=format-security</a></li><li><a href="#如何快捷生成-sum" class="table-of-contents__link toc-highlight">如何快捷生成 sum</a></li><li><a href="#修代码优先还是改编译-flag-优先" class="table-of-contents__link toc-highlight">修代码优先还是改编译 flag 优先？</a></li><li><a href="#noqemu" class="table-of-contents__link toc-highlight">noqemu</a></li><li><a href="#rust" class="table-of-contents__link toc-highlight">Rust</a></li><li><a href="#sse-related-issue" class="table-of-contents__link toc-highlight">SSE Related issue</a></li><li><a href="#go" class="table-of-contents__link toc-highlight">Go</a><ul><li><a href="#patch-go-dep" class="table-of-contents__link toc-highlight">Patch <code>go dep</code></a></li><li><a href="#给-go-包的依赖的依赖打patch的正确方式" class="table-of-contents__link toc-highlight">给 go 包的依赖（的依赖）打patch的正确方式</a></li><li><a href="#编译-golang-包的时候经常卡死" class="table-of-contents__link toc-highlight">编译 golang 包的时候经常卡死</a></li></ul></li><li><a href="#版本号" class="table-of-contents__link toc-highlight">版本号</a></li><li><a href="#循环依赖" class="table-of-contents__link toc-highlight">循环依赖</a></li><li><a href="#intel-related" class="table-of-contents__link toc-highlight">Intel related</a></li><li><a href="#qmake" class="table-of-contents__link toc-highlight">Qmake</a></li><li><a href="#xx-is-not-available-for-the-riscv64-architecture" class="table-of-contents__link toc-highlight">XX is not available for the &#39;riscv64&#39; architecture</a></li><li><a href="#msse" class="table-of-contents__link toc-highlight">msse</a></li><li><a href="#unknown-public-key-a-za-z0-9" class="table-of-contents__link toc-highlight">Unknown public key <code>[a-zA-Z0-9]+</code></a></li><li><a href="#electron" class="table-of-contents__link toc-highlight">Electron</a></li><li><a href="#node-sass" class="table-of-contents__link toc-highlight">node-sass</a></li><li><a href="#关于-upstream" class="table-of-contents__link toc-highlight">关于 upstream</a></li><li><a href="#python-2to3" class="table-of-contents__link toc-highlight">Python 2to3</a></li><li><a href="#测试" class="table-of-contents__link toc-highlight">测试</a></li><li><a href="#访问一些会在编译期被删除的文件" class="table-of-contents__link toc-highlight">访问一些会在编译期被删除的文件</a></li><li><a href="#gcc-nostdlib" class="table-of-contents__link toc-highlight">gcc nostdlib</a></li><li><a href="#glibc-optimization" class="table-of-contents__link toc-highlight">glibc optimization</a></li><li><a href="#patch-hunk-offset" class="table-of-contents__link toc-highlight">patch hunk offset</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Documents</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/felixonmars/archriscv-packages" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Avimitin, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.4a9f3433.js"></script>
<script src="/assets/js/main.760832d3.js"></script>
</body>
</html>